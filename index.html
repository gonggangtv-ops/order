<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xprinter Web POS - Connectivity Check</title>
    <style>
        :root { --blue: #3f72af; --light-blue: #dbe2ef; --bg: #f9f7f7; --success: #28a745; --danger: #dc3545; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; flex-direction: column; }
        
        header { background: var(--blue); color: white; padding: 15px 20px; display: flex; align-items: center; font-weight: bold; }
        .wrapper { display: flex; flex: 1; overflow: hidden; }
        aside { width: 220px; background: white; border-right: 1px solid #ddd; }
        .menu-item { padding: 20px; cursor: pointer; border-left: 5px solid transparent; color: #555; }
        .menu-item.active { background: var(--light-blue); color: var(--blue); border-left-color: var(--blue); font-weight: bold; }

        main { flex: 1; padding: 30px; overflow-y: auto; background: white; }
        .printer-grid { display: flex; gap: 20px; flex-wrap: wrap; }
        
        .card { width: 300px; border: 1px solid #eee; border-radius: 10px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background: var(--success); }
        .offline { background: var(--danger); }
        .checking { background: #ffc107; }

        .card-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .btn-s { flex: 1; padding: 8px; border: 1px solid var(--blue); background: white; color: var(--blue); border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
        .btn-check { background: var(--blue); color: white; }

        .add-card { border: 2px dashed var(--blue); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: var(--blue); width: 300px; height: 165px; border-radius: 10px; }

        /* Order Screen */
        #voice-ui { text-align: center; }
        .mic-btn { width: 100px; height: 100px; border-radius: 50%; border: none; background: var(--danger); color: white; font-size: 35px; cursor: pointer; margin: 20px 0; }
        .order-box { border: 1px solid #ddd; border-radius: 10px; padding: 15px; min-height: 150px; text-align: left; margin: 15px auto; max-width: 450px; background: #fafafa; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index: 1000; }
        .modal-content { background:white; padding:25px; border-radius:15px; width:300px; }
        input { width:100%; padding:12px; margin:10px 0; border:1px solid #ccc; border-radius:8px; box-sizing:border-box; }
    </style>
</head>
<body>

<header>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</header>

<div class="wrapper">
    <aside>
        <div class="menu-item active" onclick="switchPage('settings')">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≠‡∏û‡πà‡∏ß‡∏á</div>
        <div class="menu-item" onclick="switchPage('voice')">üõí ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á</div>
    </aside>

    <main>
        <section id="page-settings">
            <h3>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
            <div class="printer-grid" id="printer-list">
                <div class="add-card" onclick="openModal()">
                    <span style="font-size: 2rem;">+</span>
                    <strong>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (LAN)</strong>
                </div>
            </div>
        </section>

        <section id="page-voice" style="display:none;">
            <div id="voice-ui">
                <h2>‡πÇ‡∏ï‡πä‡∏∞ <input type="number" id="table-no" value="1" style="width:50px; border:none; border-bottom:2px solid #333; font-size:1.5rem; text-align:center;"></h2>
                <div class="order-box" id="order-preview">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á...</div>
                <button class="mic-btn" onclick="startRecognition()">üé§</button>
                <br>
                <button onclick="printBill()" style="background:var(--success); color:white; border:none; padding:15px 40px; border-radius:30px; font-size:1.2rem; cursor:pointer; font-weight:bold;">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (Auto-Cut)</button>
            </div>
        </section>
    </main>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <h3>‡πÄ‡∏û‡∏¥‡πà‡∏° Xprinter LAN</h3>
        <input type="text" id="p-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏£‡∏±‡∏ß)">
        <input type="text" id="p-ip" placeholder="IP Address (192.168.1.xxx)">
        <button onclick="savePrinter()" style="width:100%; padding:12px; background:var(--blue); color:white; border:none; border-radius:8px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button onclick="closeModal()" style="width:100%; border:none; margin-top:10px; color:#666; background:none;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<script>
    let printers = JSON.parse(localStorage.getItem('my_printers')) || [];
    let orders = [];

    function switchPage(page) {
        document.getElementById('page-settings').style.display = page === 'settings' ? 'block' : 'none';
        document.getElementById('page-voice').style.display = page === 'voice' ? 'block' : 'none';
        document.querySelectorAll('.menu-item').forEach(m => m.classList.toggle('active', m.innerText.includes(page === 'settings' ? '‡∏ï‡πà‡∏≠‡∏û‡πà‡∏ß‡∏á' : '‡πÄ‡∏™‡∏µ‡∏¢‡∏á')));
    }

    function openModal() { document.getElementById('modal').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    function savePrinter() {
        const name = document.getElementById('p-name').value;
        const ip = document.getElementById('p-ip').value;
        if(name && ip) {
            printers.push({ name, ip, status: 'checking' });
            localStorage.setItem('my_printers', JSON.stringify(printers));
            renderPrinters();
            closeModal();
            checkConnectivity(ip, printers.length - 1); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (Ping)
    async function checkConnectivity(ip, index) {
        const statusDot = document.getElementById(`dot-${index}`);
        const statusText = document.getElementById(`text-${index}`);
        
        statusDot.className = 'status-dot checking';
        statusText.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

        try {
            // ‡∏™‡πà‡∏á Request ‡πÑ‡∏õ‡∏ó‡∏µ‡πà IP ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÑ‡∏´‡∏°
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000); // ‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

            await fetch(`http://${ip}/cgi-bin/print`, { 
                method: 'HEAD', 
                mode: 'no-cors',
                signal: controller.signal 
            });

            statusDot.className = 'status-dot online';
            statusText.innerText = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
            statusText.style.color = '#28a745';
        } catch (e) {
            statusDot.className = 'status-dot offline';
            statusText.innerText = '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö IP/Wi-Fi)';
            statusText.style.color = '#dc3545';
        }
    }

    function renderPrinters() {
        const list = document.getElementById('printer-list');
        list.innerHTML = `<div class="add-card" onclick="openModal()"><span style="font-size:2rem;">+</span><strong>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (LAN)</strong></div>`;
        printers.forEach((p, i) => {
            list.innerHTML += `
                <div class="card">
                    <div style="float:right;">
                        <span id="dot-${i}" class="status-dot checking"></span>
                        <span id="text-${i}" style="font-size:0.7rem;">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à...</span>
                    </div>
                    <h4>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå${p.name}</h4>
                    <p style="font-size:0.8rem; color:#888;">IP: ${p.ip}</p>
                    <div class="card-buttons">
                        <button class="btn-s btn-check" onclick="checkConnectivity('${p.ip}', ${i})">üîÑ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì</button>
                        <button class="btn-s" onclick="testPrint('${p.ip}')">üìÑ ‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                        <button class="btn-s" style="border-color:red; color:red;" onclick="deletePrinter(${i})">‡∏•‡∏ö</button>
                    </div>
                </div>`;
            checkConnectivity(p.ip, i); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        });
    }

    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'th-TH';
    function startRecognition() { recognition.start(); }
    recognition.onresult = (e) => {
        orders.push(e.results[0][0].transcript);
        document.getElementById('order-preview').innerHTML = orders.map((o, i) => `<div>${i+1}. ${o}</div>`).join('');
    };

    async function printBill() {
        const table = document.getElementById('table-no').value;
        let data = `\x1B\x40\x1B\x61\x01\x1D\x21\x11 TABLE: ${table}\x1D\x21\x00\n\n`;
        orders.forEach((o, i) => { data += `${i+1}. ${o}\n`; });
        data += `\n\n\n\n\x1D\x56\x41\x03`;

        for(let p of printers) {
            fetch(`http://${p.ip}/cgi-bin/print`, { method: 'POST', mode: 'no-cors', body: data });
        }
        alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß!");
        orders = [];
        document.getElementById('order-preview').innerHTML = "‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
    }

    function testPrint(ip) {
        fetch(`http://${ip}/cgi-bin/print`, { method: 'POST', mode: 'no-cors', body: "\x1B\x40TEST PRINT\nXP-80T ONLINE\n\n\n\x1D\x56\x41\x03" });
    }

    function deletePrinter(i) {
        printers.splice(i, 1);
        localStorage.setItem('my_printers', JSON.stringify(printers));
        renderPrinters();
    }

    renderPrinters();
</script>

</body>
</html>
